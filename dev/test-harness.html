<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Paper Wings! – Тестовый стенд</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Roboto&display=swap" rel="stylesheet">
  <style>
    body.test-harness {
      position: relative;
      background: radial-gradient(circle at top, #1a2338 0%, #0c1220 60%, #070b15 100%);
      color: #f5f7ff;
      overflow: auto;
      touch-action: auto;
      min-height: 100vh;
      padding: 0;
    }

    .harness-stage {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .harness-stage > * {
      pointer-events: auto;
    }

    .harness-panel {
      position: fixed;
      top: 16px;
      bottom: 16px;
      width: 280px;
      padding: 16px 18px 20px;
      overflow-y: auto;
      background: rgba(12, 18, 32, 0.92);
      border: 1px solid rgba(94, 154, 255, 0.25);
      border-radius: 16px;
      box-shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
      color: #f5f7ff;
      z-index: 1500;
      backdrop-filter: blur(4px);
    }

    .harness-panel h1 {
      margin: 0 0 18px;
      font-size: 1.4rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #9ab4ff;
    }

    .harness-panel h2,
    .harness-panel h3 {
      margin: 12px 0 8px;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #b6c6ff;
    }

    .harness-panel p,
    .harness-panel label,
    .harness-panel dt,
    .harness-panel dd {
      font-size: 0.88rem;
      line-height: 1.4;
    }

    .harness-panel small {
      color: #8ea0d8;
      font-size: 0.78rem;
    }

    .harness-panel--left {
      left: 16px;
    }

    .harness-panel--right {
      right: 16px;
    }

    .harness-section {
      margin-bottom: 20px;
      border-top: 1px solid rgba(94, 154, 255, 0.18);
      padding-top: 14px;
    }

    .harness-section:first-of-type {
      border-top: none;
      padding-top: 0;
    }

    .test-harness .test-controls {
      position: static;
      top: auto;
      right: auto;
      left: auto;
      width: 100%;
      max-width: none;
      z-index: auto;
      background: rgba(20, 27, 46, 0.82);
      box-shadow: inset 0 0 0 1px rgba(94, 154, 255, 0.25);
      backdrop-filter: none;
    }

    .test-harness .test-controls__toggle {
      border-radius: 12px 12px 0 0;
      background: linear-gradient(135deg, rgba(54, 98, 180, 0.9), rgba(35, 64, 120, 0.9));
    }

    .test-harness .test-controls__body {
      padding: 14px;
      background: transparent;
    }

    .test-harness .test-controls__actions button {
      background: rgba(255, 255, 255, 0.18);
    }

    .harness-button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .harness-button-group button,
    .harness-panel button {
      flex: 1 1 calc(50% - 4px);
      padding: 8px 10px;
      font-size: 0.85rem;
      border-radius: 10px;
      border: 1px solid rgba(129, 170, 255, 0.4);
      background: linear-gradient(135deg, rgba(32, 54, 96, 0.75), rgba(21, 33, 61, 0.75));
      color: #f5f7ff;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease, box-shadow 0.15s ease;
    }

    .harness-panel button:hover {
      background: linear-gradient(135deg, rgba(51, 80, 138, 0.9), rgba(27, 44, 81, 0.9));
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
    }

    .harness-panel button:active {
      transform: translateY(1px);
    }

    .harness-panel button.full-width {
      flex: 1 1 100%;
    }

    #modeMenuMain[hidden],
    #modeMenuAdvanced[hidden] {
      display: none !important;
    }

    body.harness-advanced-open {
      overflow: auto;
    }

    body.harness-advanced-open #gameContainer {
      position: relative;
      width: min(90vw, 560px);
      max-width: 560px;
      height: auto;
      background-image: none;
      background-color: transparent;
    }

    body.harness-advanced-open .harness-stage {
      align-items: flex-start;
      justify-content: flex-start;
      padding-top: clamp(24px, 6vh, 48px);
    }

    body.harness-advanced-open #modeMenu {
      position: relative;
      top: auto;
      left: auto;
      transform: none;
      width: 100%;
      max-width: 560px;
      margin: clamp(20px, 5vw, 40px) auto;
      padding: clamp(18px, 3vw, 24px);
      border-radius: 18px;
      border: 1px solid rgba(94, 154, 255, 0.35);
      background: rgba(12, 18, 32, 0.92);
      box-shadow: 0 18px 48px rgba(0, 0, 0, 0.45);
      justify-content: flex-start;
      align-items: stretch;
      overflow: visible;
    }

    body.harness-advanced-open #modeMenu .game-title {
      color: #9ab4ff;
      text-shadow: none;
      margin-bottom: 22px;
    }

    #modeMenuAdvanced {
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 3vw, 28px);
      width: 100%;
    }

    #modeMenuAdvanced .control-group-row {
      gap: clamp(14px, 2.5vw, 20px);
    }

    #modeMenuAdvanced .control-box {
      background: linear-gradient(145deg, rgba(234, 239, 241, 0.92), rgba(214, 217, 218, 0.92));
      border-color: rgba(248, 1, 1, 0.65);
    }

    body.harness-advanced-open #modeMenu .mode-btn {
      width: 100%;
    }

    body.harness-advanced-open #modeMenu .control-buttons {
      width: 100%;
    }

    body.harness-advanced-open #modeMenu .control-box select {
      width: 100%;
    }

    body.harness-advanced-open #modeMenu .aa-toggle {
      width: 100%;
    }

    body.harness-advanced-open #modeMenu .aa-toggle .toggle-label {
      width: 100%;
      justify-content: space-between;
      color: #1b243d;
      background: rgba(255, 255, 255, 0.7);
    }

    body.harness-advanced-open #mantisIndicator,
    body.harness-advanced-open #goatIndicator,
    body.harness-advanced-open .game-wrap,
    body.harness-advanced-open #overlayContainer,
    body.harness-advanced-open #endGameButtons {
      display: none !important;
    }

    body.harness-advanced-open #modeMenu {
      pointer-events: auto;
    }

    body.harness-advanced-open #modeMenuAdvanced {
      position: relative;
    }

    .harness-panel input,
    .harness-panel select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(129, 170, 255, 0.35);
      background: rgba(9, 14, 27, 0.9);
      color: #f5f7ff;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }

    .harness-panel select:disabled,
    .harness-panel button:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px 12px;
      margin: 0;
      padding: 0;
    }

    .status-grid dt {
      margin: 0;
      color: #8ea0d8;
      font-weight: 600;
    }

    .status-grid dd {
      margin: 0;
    }

    .plane-details {
      background: rgba(7, 11, 22, 0.8);
      border: 1px solid rgba(129, 170, 255, 0.25);
      border-radius: 12px;
      padding: 10px 12px;
      margin-top: 8px;
      font-size: 0.82rem;
      line-height: 1.45;
    }

    .plane-details strong {
      color: #d6e0ff;
    }

    .harness-note {
      margin: 0;
      font-size: 0.78rem;
      color: #8095d5;
    }

    @media (max-width: 1280px) {
      .harness-panel {
        width: 240px;
      }
    }

    @media (max-width: 1100px) {
      .harness-panel--left,
      .harness-panel--right {
        position: static;
        width: auto;
        margin: 12px 16px;
      }

      .harness-stage {
        flex-direction: column;
        padding-top: 12px;
      }
    }
  </style>
</head>
<body class="test-harness">
  <aside class="harness-panel harness-panel--left" aria-label="Панель управления режимами">
    <h1>Test Harness</h1>

    <div class="harness-section" aria-labelledby="flowTitle">
      <h2 id="flowTitle">Управление раундами</h2>
      <div class="harness-button-group">
        <button id="resetGameBtn" class="full-width">Полный сброс</button>
        <button id="startRoundBtn" class="full-width">Старт нового раунда</button>
        <button id="startLoopBtn">Запуск цикла</button>
        <button id="stopLoopBtn">Стоп цикла</button>
        <button id="showMenuBtn">Показать меню</button>
        <button id="hideMenuBtn">Спрятать меню</button>
      </div>
      <div class="harness-button-group">
        <button id="forceGreenWinBtn">Победа зелёных</button>
        <button id="forceBlueWinBtn">Победа синих</button>
        <button id="showEndScreenBtn">Показать энд-скрин</button>
        <button id="hideEndScreenBtn">Скрыть энд-скрин</button>
      </div>
      <div class="harness-button-group">
        <button id="lockRoundWinBtn" class="full-width" title="Завершить раунд без показа финального экрана">Завершить раунд (без энд-скрина)</button>
        <button id="lockGameWinBtn" class="full-width" title="Завершить игру с показом финального экрана">Завершить игру (с энд-скрином)</button>
      </div>
      <small>Используйте кнопки для отладки смены фаз, меню и сценариев конца раунда или всей игры.</small>
    </div>

    <div class="harness-section" aria-labelledby="settingsTitle">
      <h2 id="settingsTitle">Настройки карты</h2>
      <div class="harness-button-group">
        <button id="toggleAAButton">ПВО: выкл.</button>
        <button id="toggleEdgesButton">Контуры: выкл.</button>
        <button id="nextMapButton" class="full-width">Следующая карта</button>
      </div>
      <small>Переключение настроек сразу пересоздаёт раунд для применения.</small>
    </div>

    <div class="harness-section harness-section--test-controls" aria-labelledby="testControlsHeading">
      <h2 id="testControlsHeading">Расширенные настройки</h2>
      <div id="testControlPanel" class="test-controls collapsed" aria-live="polite">
        <button id="testControlsToggle" class="test-controls__toggle" aria-expanded="false" type="button">
          Test Controls
        </button>
        <div class="test-controls__body" id="testControlsBody">
          <div class="test-controls__field">
            <label for="inGameMapSelect" class="test-controls__label visually-hidden">Map</label>
            <select id="inGameMapSelect" class="test-controls__select"></select>
          </div>
          <div class="test-controls__field">
            <label for="inGameFlameStyle" class="test-controls__label">Flame Style</label>
            <select id="inGameFlameStyle" class="test-controls__select"></select>
          </div>
          <div class="test-controls__field">
            <label for="testRange" class="test-controls__label visually-hidden">Range (cells)</label>
            <input id="testRange" class="test-controls__input" type="number" min="5" max="30" step="1" inputmode="numeric" />
          </div>
          <div class="test-controls__field">
            <label for="testAmplitude" class="test-controls__label visually-hidden">Aiming Amplitude (°)</label>
            <input id="testAmplitude" class="test-controls__input" type="number" min="0" max="120" step="1" inputmode="decimal" />
          </div>
          <label class="test-controls__checkbox">
            <input type="checkbox" id="testAddAAToggle" />
            <span>Include AA placement phase</span>
          </label>
          <label class="test-controls__checkbox">
            <input type="checkbox" id="testSharpEdgesToggle" />
            <span>Enable sharp arena edges</span>
          </label>
          <label class="test-controls__checkbox">
            <input type="checkbox" id="testRandomizeToggle" />
            <span>Randomize map each round</span>
          </label>
          <div class="test-controls__actions">
            <button id="testApplyBtn" type="button">Apply</button>
            <button id="testRestartBtn" type="button">Apply &amp; Restart</button>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <div class="harness-stage">
    <div id="gameContainer">
      <div class="game-wrap">
        <canvas id="gameCanvas" width="360" height="640"></canvas>
      </div>


      <div id="hudPlaneStyleProbes" aria-hidden="true"
           style="position:absolute;width:0;height:0;overflow:hidden;clip-path:inset(50%);">
        <img src="ui_gamescreen/gamescreen_outside/planecounter_ green.png" class="hud-plane green" alt="" draggable="false">
        <img src="ui_gamescreen/gamescreen_outside/planecounter_blue.png" class="hud-plane blue" alt="" draggable="false">
      </div>

      <div id="mantisIndicator" class="turn-indicator" style="display:none;"></div>
      <div id="goatIndicator" class="turn-indicator" style="display:none;"></div>
      <div id="harnessInspectorOverlay" class="inspector-overlay" aria-hidden="true">
        <svg id="inspectorSvg" class="inspector-overlay__svg" viewBox="0 0 460 800" preserveAspectRatio="none">
          <line id="inspectorCrosshairH" class="inspector-overlay__crosshair" x1="0" y1="0" x2="460" y2="0"></line>
          <line id="inspectorCrosshairV" class="inspector-overlay__crosshair" x1="0" y1="0" x2="0" y2="800"></line>
          <line id="inspectorRulerLine" class="inspector-overlay__ruler-line" x1="0" y1="0" x2="0" y2="0"></line>
          <circle id="inspectorPointA" class="inspector-overlay__point" cx="0" cy="0" r="5"></circle>
          <circle id="inspectorPointB" class="inspector-overlay__point" cx="0" cy="0" r="5"></circle>
        </svg>
        <div id="inspectorTooltip" class="inspector-overlay__tooltip" role="status" aria-live="polite">
          <div id="inspectorTooltipContent" class="inspector-overlay__tooltip-content">
            <div class="inspector-overlay__row">
              <strong>Курсор</strong>
              <span id="inspectorCursorText" class="inspector-overlay__value">—</span>
            </div>
            <div class="inspector-overlay__row">
              <strong>Объект</strong>
              <span id="inspectorTargetText" class="inspector-overlay__value">—</span>
            </div>
            <div class="inspector-overlay__row">
              <strong>Линейка</strong>
              <span id="inspectorRulerText" class="inspector-overlay__value">—</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="overlayContainer" aria-hidden="true">
      <canvas id="aimCanvas" width="360" height="640" style="display:none;"></canvas>
      <canvas id="planeCanvas" style="display:none;"></canvas>
    </div>

    <div id="modeMenu" data-inspector-name="Меню">
      <div id="modeMenuMain">
        <h1 class="game-title">Paper Wings!</h1>

        <div class="mode-options">
          <button id="hotSeatBtn" class="mode-btn">Hot Seat</button>
          <button id="computerBtn" class="mode-btn">Computer</button>
          <button id="onlineBtn" class="mode-btn" disabled>Online</button>
        </div>

        <button id="playBtn" class="disabled" disabled>Play</button>

        <div class="rules-options">
          <button id="classicRulesBtn" class="rules-btn selected">Classic Rules</button>
          <button id="advancedSettingsBtn" class="rules-btn">Advanced Settings</button>
        </div>
      </div>

      <div id="modeMenuAdvanced" hidden aria-hidden="true" data-inspector-name="Расширенные настройки">
        <h1 class="game-title"><span class="visually-hidden">Advanced Settings</span></h1>

        <div class="control-group-row">
          <div class="control-pair-row">
            <div class="control-box">
                <div class="control-label visually-hidden">Range</div>
                <div id="rangeIndicator" class="control-visual">
                  <div class="jet">
                  <div class="wing-trail top"></div>
                  <div class="wing-trail bottom"></div>
                  <svg class="jet-plane" viewBox="0 0 38 20">
                    <polygon points="38,10 8,20 8,15 0,10 8,5 8,0"></polygon>
                  </svg>
                </div>
                <div class="range-display range-legacy-digits--hidden">
                  <div class="range-strip-viewport" aria-hidden="true">
                      <div id="rangeStrip" class="range-strip">
                      <div class="range-strip__value">5</div>
                      <div class="range-strip__value">10</div>
                      <div class="range-strip__value">15</div>
                      <div class="range-strip__value">20</div>
                      <div class="range-strip__value">25</div>
                      <div class="range-strip__value">30</div>
                    </div>
                  </div>
                    <span id="rangeDisplay" class="range-display__value">10 клеток</span>
                  </div>
                </div>
                <div class="control-buttons">
                  <button
                    id="rangeMinus"
                    class="control-btn control-btn--minus"
                    type="button"
                    aria-label="Decrease flight range"
                  >
                    <span class="visually-hidden">Decrease flight range</span>
                  </button>
                  <button
                    id="rangePlus"
                    class="control-btn control-btn--plus"
                    type="button"
                    aria-label="Increase flight range"
                >
                  <span class="visually-hidden">Increase flight range</span>
                </button>
              </div>
            </div>

            <div class="control-box">
              <div class="control-label visually-hidden">Aiming Amplitude</div>
              <div id="amplitudeIndicator" class="control-visual">
                <div class="crosshair">
                  <div class="inner-circle"></div>
                  <div class="center-dot"></div>
                  <div class="horizontal"></div>
                  <div class="vertical"></div>
                </div>
              </div>
              <div class="control-value"><span id="amplitudeAngleDisplay">40°</span></div>
              <div class="control-buttons">
                <button
                  id="amplitudeMinus"
                  class="control-btn control-btn--minus"
                  type="button"
                  aria-label="Decrease aiming amplitude"
                >
                  <span class="visually-hidden">Decrease aiming amplitude</span>
                </button>
                <button
                  id="amplitudePlus"
                  class="control-btn control-btn--plus"
                  type="button"
                  aria-label="Increase aiming amplitude"
                >
                  <span class="visually-hidden">Increase aiming amplitude</span>
                </button>
              </div>
            </div>
          </div>

          <div class="control-box">
            <div class="control-label visually-hidden">Map</div>
            <div class="control-visual map-preview">
              <div class="map-preview-layer map-preview-paper"></div>
              <div class="map-preview-layer map-preview-image" id="mapPreview"></div>
            </div>
            <div class="control-value"></div>
            <div class="control-buttons">
              <div class="map-selector" role="group" aria-label="Select map">
                <button
                  id="instance_field_left"
                  class="control-btn control-btn--map control-btn--map-prev"
                  type="button"
                  aria-label="Previous map"
                >
                  <span class="visually-hidden">Previous map</span>
                </button>
                <button
                  id="instance_field_right"
                  class="control-btn control-btn--map control-btn--map-next"
                  type="button"
                  aria-label="Next map"
                >
                  <span class="visually-hidden">Next map</span>
                </button>
              </div>
            </div>
          </div>

          <div class="control-box" id="additionalSettings">
            <div class="control-label visually-hidden">Additional Settings</div>
            <div class="aa-toggle">
              <input type="checkbox" id="addAAToggle" class="toggle-input visually-hidden" />
              <label for="addAAToggle" class="toggle-label">
                <span class="toggle-visual" aria-hidden="true"></span>
                <span class="toggle-text visually-hidden">Add Anti-Aircraft</span>
              </label>
            </div>
            <div class="aa-toggle">
              <input type="checkbox" id="sharpEdgesToggle" class="toggle-input visually-hidden" />
              <label for="sharpEdgesToggle" class="toggle-label">
                <span class="toggle-visual" aria-hidden="true"></span>
                <span class="toggle-text visually-hidden">Sharp Edges</span>
              </label>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div id="endGameButtons" style="display:none;">
      <p>Play Again?</p>
      <button id="yesButton" class="end-btn">Yes</button>
      <button id="noButton" class="end-btn">No</button>
    </div>
  </div>

  <aside class="harness-panel harness-panel--right" aria-label="Сценарии и эффекты">
    <h1>Сценарии</h1>

    <div class="harness-section" aria-labelledby="inspectorTitle">
      <h2 id="inspectorTitle">Инспектор поля</h2>
      <div class="harness-button-group">
        <button id="toggleInspectorBtn" class="full-width">Курсор: выкл.</button>
        <button id="toggleRulerBtn" class="full-width" disabled>Линейка: выкл.</button>
      </div>
      <dl class="status-grid inspector-status">
        <div><dt>Курсор</dt><dd id="inspectorCursorPanel">—</dd></div>
        <div><dt>Объект</dt><dd id="inspectorTargetPanel">—</dd></div>
        <div><dt>Точка A</dt><dd id="inspectorPointAPanel">—</dd></div>
        <div><dt>Точка B</dt><dd id="inspectorPointBPanel">—</dd></div>
        <div><dt>Расстояние</dt><dd id="inspectorDistancePanel">—</dd></div>
      </dl>
      <p class="harness-note">Активируйте курсор, чтобы видеть координаты и объект под указателем. Линейка фиксирует две точки и рассчитывает расстояние между ними.</p>
    </div>

    <div class="harness-section" aria-labelledby="stateTitle">
      <h2 id="stateTitle">Состояние</h2>
      <dl class="status-grid">
        <div><dt>Раунд</dt><dd id="statusRound">–</dd></div>
        <div><dt>Фаза</dt><dd id="statusPhase">–</dd></div>
        <div><dt>Ход</dt><dd id="statusTurn">–</dd></div>
        <div><dt>Стрелять?</dt><dd id="statusAwaiting">–</dd></div>
        <div><dt>ПВО</dt><dd id="statusAA">–</dd></div>
      </dl>
      <p class="harness-note">Значения обновляются автоматически каждые 0.5 секунды.</p>
    </div>

    <div class="harness-section" aria-labelledby="scoreTitle">
      <h2 id="scoreTitle">Очки и прогресс матча</h2>
      <p>Текущие очки: <strong id="scoreGreen">0</strong> — <strong id="scoreBlue">0</strong></p>
      <div class="harness-button-group">
        <button data-score="green:+1">Зелёные +1</button>
        <button data-score="blue:+1">Синие +1</button>
        <button data-score="green:-1">Зелёные −1</button>
        <button data-score="blue:-1">Синие −1</button>
        <button data-score="green:+5">Зелёные +5</button>
        <button data-score="blue:+5">Синие +5</button>
      </div>
    </div>

    <div class="harness-section" aria-labelledby="planesTitle">
      <h2 id="planesTitle">Самолёты</h2>
      <label for="planeSelect">Целевой самолёт</label>
      <select id="planeSelect" aria-describedby="planeInfoNote"></select>
      <p id="planeInfoNote" class="harness-note">Список обновляется после сброса/старта раунда.</p>
      <div class="plane-details" id="planeDetails">
        <p>Нет выбранного самолёта.</p>
      </div>
      <div class="harness-button-group">
        <button id="toggleAliveBtn">Переключить статус</button>
        <button id="ignitePlaneBtn">Поджечь</button>
        <button id="extinguishPlaneBtn">Потушить</button>
      </div>
      <div class="harness-button-group">
        <button id="scheduleFlameBtn">Пламя после взрыва</button>
        <button id="refreshPlanesBtn">Обновить список</button>
      </div>
    </div>

  </aside>

  <script src="script.js"></script>
  <script src="settings.js"></script>
  <script src="test-inspector.js"></script>
  <script>
    (function(){
      const planeSelect = document.getElementById('planeSelect');
      const planeDetails = document.getElementById('planeDetails');
      const gameContainerEl = document.getElementById('gameContainer');
      const statusElements = {
        round: document.getElementById('statusRound'),
        phase: document.getElementById('statusPhase'),
        turn: document.getElementById('statusTurn'),
        awaiting: document.getElementById('statusAwaiting'),
        aa: document.getElementById('statusAA'),
        scoreGreen: document.getElementById('scoreGreen'),
        scoreBlue: document.getElementById('scoreBlue')
      };

      const HARNESS_FIELD_WIDTH = 460;
      const HARNESS_FIELD_HEIGHT = 800;

      const overlayElement = document.getElementById('harnessInspectorOverlay');
      const overlaySvg = document.getElementById('inspectorSvg');
      const overlayTooltip = document.getElementById('inspectorTooltip');
      const overlayTooltipContent = document.getElementById('inspectorTooltipContent');
      const inspectorButtons = {
        cursor: document.getElementById('toggleInspectorBtn'),
        ruler: document.getElementById('toggleRulerBtn')
      };
      const inspectorPanel = {
        cursor: document.getElementById('inspectorCursorPanel'),
        target: document.getElementById('inspectorTargetPanel'),
        pointA: document.getElementById('inspectorPointAPanel'),
        pointB: document.getElementById('inspectorPointBPanel'),
        distance: document.getElementById('inspectorDistancePanel')
      };
      let inspectorInstance = null;

      function attachHarnessInspector(isAdvanced){
        const init = window.paperWingsTestInspector?.init;
        if(typeof init !== 'function'){
          return;
        }
        inspectorInstance?.destroy?.();
        const modeMenuEl = document.getElementById('modeMenu');
        const advancedRoot = document.getElementById('modeMenuAdvanced');
        const baseOptions = {
          overlay: overlayElement,
          svg: overlaySvg,
          tooltip: overlayTooltip,
          tooltipContent: overlayTooltipContent,
          cursorValue: document.getElementById('inspectorCursorText'),
          targetValue: document.getElementById('inspectorTargetText'),
          rulerValue: document.getElementById('inspectorRulerText'),
          crosshairH: document.getElementById('inspectorCrosshairH'),
          crosshairV: document.getElementById('inspectorCrosshairV'),
          rulerLine: document.getElementById('inspectorRulerLine'),
          pointA: document.getElementById('inspectorPointA'),
          pointB: document.getElementById('inspectorPointB'),
          buttons: inspectorButtons,
          panel: inspectorPanel,
          storageKey: 'paperWingsInspectorState'
        };

        if(isAdvanced && advancedRoot){
          inspectorInstance = init({
            ...baseOptions,
            container: advancedRoot,
            containerMode: 'pixel',
            containerLabel: 'Расширенные настройки',
            extraRoots: [
              {
                element: gameContainerEl,
                mode: 'field',
                label: 'Поле',
                fieldWidth: HARNESS_FIELD_WIDTH,
                fieldHeight: HARNESS_FIELD_HEIGHT
              }
            ]
          });
        } else if(gameContainerEl){
          inspectorInstance = init({
            ...baseOptions,
            container: gameContainerEl,
            fieldWidth: HARNESS_FIELD_WIDTH,
            fieldHeight: HARNESS_FIELD_HEIGHT,
            containerMode: 'field',
            containerLabel: 'Поле',
            extraRoots: [
              { element: modeMenuEl, mode: 'pixel', label: 'Меню' }
            ]
          });
        }
      }

      const initialInspectorMode = window.paperWingsHarness?.isAdvancedVisible?.() || false;
      attachHarnessInspector(initialInspectorMode);

      window.addEventListener('paperWingsHarnessViewChange', event => {
        const advanced = !!event?.detail?.advanced;
        attachHarnessInspector(advanced);
        queueLayout();
      });

      function adjustHarnessLayout(){
        const game = gameContainerEl;
        if(!game) return;
        if(document.body.classList.contains('harness-advanced-open')){
          game.style.left = '';
          return;
        }
        const leftPanel = document.querySelector('.harness-panel--left');
        const rightPanel = document.querySelector('.harness-panel--right');
        const leftWidth = leftPanel ? leftPanel.getBoundingClientRect().width + 24 : 24;
        const rightWidth = rightPanel ? rightPanel.getBoundingClientRect().width + 24 : 24;
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth || 0;
        const gameRect = game.getBoundingClientRect();
        const gameWidth = gameRect.width || game.offsetWidth || 0;
        const available = viewportWidth - leftWidth - rightWidth;
        if(available > 0 && gameWidth > 0){
          const newLeft = leftWidth + Math.max((available - gameWidth) / 2, 0);
          game.style.left = Math.round(newLeft) + 'px';
        }
      }

      function queueLayout(){
        requestAnimationFrame(adjustHarnessLayout);
      }

      function patchFunction(name, after){
        const original = window[name];
        if(typeof original !== 'function') return;
        window[name] = function patchedFunction(){
          const result = original.apply(this, arguments);
          try {
            after?.();
          } catch(err) {
            console.error('[Harness] Ошибка пост-обработки', err);
          }
          return result;
        };
      }

      function refreshPlaneOptions(){
        if(!planeSelect) return;
        const planes = Array.isArray(window.points) ? window.points : [];
        const previousValue = planeSelect.value;
        planeSelect.innerHTML = '';
        planes.forEach((plane, index) => {
          const option = document.createElement('option');
          const status = plane.isAlive ? 'жив' : 'сбит';
          option.value = String(index);
          option.textContent = `${index + 1}. ${plane.color || '—'} · ${status}`;
          planeSelect.append(option);
        });
        if(planes.length === 0){
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'Нет самолётов';
          planeSelect.append(option);
          planeSelect.disabled = true;
        } else {
          planeSelect.disabled = false;
          if(previousValue && planeSelect.querySelector(`option[value="${previousValue}"]`)){
            planeSelect.value = previousValue;
          } else {
            planeSelect.selectedIndex = 0;
          }
        }
        updatePlaneDetails();
      }

      function formatNumber(value){
        return Number.isFinite(value) ? Math.round(value) : '—';
      }

      function getSelectedPlane(){
        if(!planeSelect || planeSelect.disabled) return null;
        const index = parseInt(planeSelect.value, 10);
        const planes = Array.isArray(window.points) ? window.points : [];
        if(Number.isInteger(index) && index >= 0 && index < planes.length){
          return planes[index];
        }
        return null;
      }

      function updatePlaneDetails(){
        const plane = getSelectedPlane();
        if(!plane){
          planeDetails.innerHTML = '<p>Нет выбранного самолёта.</p>';
          return;
        }
        const lines = [
          `<p><strong>Цвет:</strong> ${plane.color || 'неизвестно'}</p>`,
          `<p><strong>Координаты:</strong> ${formatNumber(plane.x)}, ${formatNumber(plane.y)}</p>`,
          `<p><strong>Статус:</strong> ${plane.isAlive ? 'в строю' : 'сбит'}</p>`,
          `<p><strong>Горит:</strong> ${plane.burning ? 'да' : 'нет'}</p>`
        ];
        if(plane.flagColor){
          lines.push(`<p><strong>Флаг:</strong> ${plane.flagColor}</p>`);
        }
        planeDetails.innerHTML = lines.join('');
      }

      function ignitePlane(plane){
        if(!plane) return;
        plane.burning = true;
        plane.flameFxDisabled = false;
        if(typeof window.spawnBurningFlameFx === 'function'){
          window.spawnBurningFlameFx(plane);
        }
      }

      function extinguishPlane(plane){
        if(!plane) return;
        plane.burning = false;
        if(typeof window.ensurePlaneFlameFx === 'function'){
          window.ensurePlaneFlameFx(plane);
        }
      }

      function updateScores(){
        if(statusElements.scoreGreen){
          statusElements.scoreGreen.textContent = Number.isFinite(window.greenScore) ? window.greenScore : '—';
        }
        if(statusElements.scoreBlue){
          statusElements.scoreBlue.textContent = Number.isFinite(window.blueScore) ? window.blueScore : '—';
        }
      }

      function updateStatus(){
        if(statusElements.round){
          statusElements.round.textContent = Number.isFinite(window.roundNumber) ? window.roundNumber : '—';
        }
        if(statusElements.phase){
          statusElements.phase.textContent = window.phase || '—';
        }
        if(statusElements.turn){
          const colors = Array.isArray(window.turnColors) ? window.turnColors : [];
          const idx = Number.isInteger(window.turnIndex) ? window.turnIndex : 0;
          statusElements.turn.textContent = colors.length ? colors[idx % colors.length] : '—';
        }
        if(statusElements.awaiting){
          statusElements.awaiting.textContent = window.awaitingFlightResolution ? 'да' : 'нет';
        }
        if(statusElements.aa){
          statusElements.aa.textContent = window.settings?.addAA ? 'включено' : 'выключено';
        }
        const aaBtn = document.getElementById('toggleAAButton');
        if(aaBtn){
          aaBtn.textContent = window.settings?.addAA ? 'ПВО: вкл.' : 'ПВО: выкл.';
        }
        const edgesBtn = document.getElementById('toggleEdgesButton');
        if(edgesBtn){
          edgesBtn.textContent = window.settings?.sharpEdges ? 'Контуры: вкл.' : 'Контуры: выкл.';
        }
        updateScores();
      }

      function queueStatusUpdate(){
        requestAnimationFrame(updateStatus);
      }

      function resolveSimulatedWinnerColor(){
        const greenScoreValue = Number.isFinite(window.greenScore) ? window.greenScore : 0;
        const blueScoreValue = Number.isFinite(window.blueScore) ? window.blueScore : 0;
        if(greenScoreValue > blueScoreValue){
          return 'green';
        }
        if(blueScoreValue > greenScoreValue){
          return 'blue';
        }
        const colors = Array.isArray(window.turnColors) ? window.turnColors : [];
        const index = Number.isInteger(window.turnIndex) ? window.turnIndex : 0;
        const fallback = colors.length ? colors[index % colors.length] : null;
        return fallback === 'blue' ? 'blue' : 'green';
      }

      function lockInSimulatedWinner(options){
        const winnerColor = resolveSimulatedWinnerColor();
        window.lockInWinner?.(winnerColor, options);
        queueStatusUpdate();
      }

      patchFunction('resetGame', () => {
        refreshPlaneOptions();
        queueStatusUpdate();
        queueLayout();
      });

      patchFunction('startNewRound', () => {
        refreshPlaneOptions();
        queueStatusUpdate();
        queueLayout();
      });

      patchFunction('resizeCanvas', () => {
        queueLayout();
      });

      document.getElementById('resetGameBtn')?.addEventListener('click', () => {
        window.resetGame?.();
      });

      document.getElementById('startRoundBtn')?.addEventListener('click', () => {
        window.startNewRound?.();
      });

      document.getElementById('startLoopBtn')?.addEventListener('click', () => {
        window.startGameLoop?.();
      });

      document.getElementById('stopLoopBtn')?.addEventListener('click', () => {
        window.stopGameLoop?.();
      });

      document.getElementById('showMenuBtn')?.addEventListener('click', () => {
        const menu = document.getElementById('modeMenu');
        if(menu) menu.style.display = 'block';
      });

      document.getElementById('hideMenuBtn')?.addEventListener('click', () => {
        const menu = document.getElementById('modeMenu');
        if(menu) menu.style.display = 'none';
      });

      document.getElementById('forceGreenWinBtn')?.addEventListener('click', () => {
        window.lockInWinner?.('green', { showEndScreen: true });
        queueStatusUpdate();
      });

      document.getElementById('forceBlueWinBtn')?.addEventListener('click', () => {
        window.lockInWinner?.('blue', { showEndScreen: true });
        queueStatusUpdate();
      });

      document.getElementById('lockRoundWinBtn')?.addEventListener('click', () => {
        lockInSimulatedWinner({ showEndScreen: false });
      });

      document.getElementById('lockGameWinBtn')?.addEventListener('click', () => {
        lockInSimulatedWinner({ showEndScreen: true });
      });

      document.getElementById('showEndScreenBtn')?.addEventListener('click', () => {
        const panel = document.getElementById('endGameButtons');
        if(panel) panel.style.display = 'block';
      });

      document.getElementById('hideEndScreenBtn')?.addEventListener('click', () => {
        const panel = document.getElementById('endGameButtons');
        if(panel) panel.style.display = 'none';
      });

      document.getElementById('toggleAAButton')?.addEventListener('click', (event) => {
        if(window.settings){
          window.settings.addAA = !window.settings.addAA;
        }
        queueStatusUpdate();
        window.startNewRound?.();
        if(event?.currentTarget){
          event.currentTarget.textContent = window.settings?.addAA ? 'ПВО: вкл.' : 'ПВО: выкл.';
        }
      });

      document.getElementById('toggleEdgesButton')?.addEventListener('click', (event) => {
        if(window.settings){
          window.settings.sharpEdges = !window.settings.sharpEdges;
        }
        queueStatusUpdate();
        window.startNewRound?.();
        if(event?.currentTarget){
          event.currentTarget.textContent = window.settings?.sharpEdges ? 'Контуры: вкл.' : 'Контуры: выкл.';
        }
      });

      document.getElementById('nextMapButton')?.addEventListener('click', () => {
        if(window.settings){
          const mapCount = 4; // обновите при добавлении новых карт
          const current = Number.isInteger(window.settings.mapIndex) ? window.settings.mapIndex : 0;
          window.settings.mapIndex = (current + 1) % mapCount;
        }
        window.startNewRound?.();
        queueStatusUpdate();
      });

      document.querySelectorAll('[data-score]')?.forEach(button => {
        button.addEventListener('click', () => {
          const value = button.dataset.score || '';
          const [color, delta] = value.split(':');
          const amount = parseInt(delta, 10);
          if(color && Number.isFinite(amount)){
            window.addScore?.(color, amount);
            queueStatusUpdate();
          }
        });
      });

        const target = targetInput && targetInput.value !== '' ? parseInt(targetInput.value, 10) : (Number.isFinite(window.greenScore) ? window.greenScore + delta : delta);
      });

        const target = targetInput && targetInput.value !== '' ? parseInt(targetInput.value, 10) : (Number.isFinite(window.blueScore) ? window.blueScore + delta : delta);
      });

        window.renderScoreboard?.();
      });

      document.getElementById('toggleAliveBtn')?.addEventListener('click', () => {
        const plane = getSelectedPlane();
        if(!plane) return;
        plane.isAlive = !plane.isAlive;
        updatePlaneDetails();
      });

      document.getElementById('ignitePlaneBtn')?.addEventListener('click', () => {
        const plane = getSelectedPlane();
        ignitePlane(plane);
        updatePlaneDetails();
      });

      document.getElementById('extinguishPlaneBtn')?.addEventListener('click', () => {
        const plane = getSelectedPlane();
        extinguishPlane(plane);
        updatePlaneDetails();
      });

      document.getElementById('scheduleFlameBtn')?.addEventListener('click', () => {
        const plane = getSelectedPlane();
        if(!plane) return;
        plane.burning = true;
        if(typeof window.schedulePlaneFlameFx === 'function'){
          window.schedulePlaneFlameFx(plane);
        }
        updatePlaneDetails();
      });

      document.getElementById('refreshPlanesBtn')?.addEventListener('click', () => {
        refreshPlaneOptions();
      });

      planeSelect?.addEventListener('change', updatePlaneDetails);

      window.addEventListener('resize', queueLayout);

      setInterval(updateStatus, 500);

      refreshPlaneOptions();
      updateStatus();
      queueLayout();
    })();
  </script>
</body>
</html>
